# B+Tree 页面工作总结

## 1. B+Tree 页面概述

B+Tree 的页面分为以下三种类型：

1. **基础页面 (Base Page)**:
    - 存储页面的元信息，如页面类型、当前大小、最大容量等。
    - 提供通用的操作接口，被叶子页面和内部页面继承。

2. **内部页面 (Internal Page)**:
    - 存储键 (`KeyType`) 和子页面的 `page_id`。
    - 通过键值对指向其他页面，用于构建树形结构。
    - 第一个键无效，起到对齐作用。

3. **叶子页面 (Leaf Page)**:
    - 存储键 (`KeyType`) 和值 (`ValueType`)。
    - 值通常为数据的 RID（Record ID），指向实际存储的记录。
    - 叶子页面通过 `next_page_id` 指针形成链表，支持范围查询。

---

## 2. 页面字段说明

### **基础页面字段**
| 字段名       | 类型             | 说明                     |
| ------------ | ---------------- | ------------------------ |
| `page_type_` | `IndexPageType`  | 页面类型（叶子/内部）    |
| `size_`      | `int`            | 当前键值对数量           |
| `max_size_`  | `int`            | 最大键值对容量           |

---

### **内部页面字段**
| 字段名            | 类型               | 说明                       |
| ----------------- | ------------------ | -------------------------- |
| `key_array_`      | `KeyType[]`        | 键数组，按升序存储         |
| `page_id_array_`  | `ValueType[]`      | 子页面 ID 数组             |

---

### **叶子页面字段**
| 字段名            | 类型               | 说明                       |
| ----------------- | ------------------ | -------------------------- |
| `key_array_`      | `KeyType[]`        | 键数组，按升序存储         |
| `rid_array_`      | `ValueType[]`      | 键对应的值数组（如 RID）   |
| `next_page_id_`   | `page_id_t`        | 指向下一叶子页面的指针     |

---

## 3. 页面工作流程

### **1. 页面初始化**
- 调用 `Init` 方法，设置页面类型、当前大小和最大容量。
- 对于叶子页面，初始化 `next_page_id_` 为 `INVALID_PAGE_ID`。

### **2. 键值对插入**
- 插入键值对时：
    1. 在数组中保持键的升序。
    2. 如果页面满了，需要分裂页面。

### **3. 键值对删除**
- 删除键值对时：
    1. 调整数组顺序。
    2. 如果页面大小小于 `max_size / 2`，需要合并或重新分配。

### **4. 页面分裂**
- 分裂操作将页面分为两部分：
    1. 前一半保留在当前页面。
    2. 后一半移动到新页面。

### **5. 页面合并**
- 当页面大小过小时，两个页面可以合并。
- 合并操作将所有键值对移动到一个页面，并更新父页面的指针。

### **6. 范围查询**
- 对叶子页面，依靠 `next_page_id_` 链接实现范围查询。

---

## 4. 页面方法总结

### **基础页面方法**
| 方法名               | 功能                                  |
| -------------------- | ------------------------------------- |
| `GetPageType`        | 获取页面类型                         |
| `SetPageType`        | 设置页面类型                         |
| `GetSize`            | 获取页面当前大小                     |
| `SetSize`            | 设置页面当前大小                     |
| `ChangeSizeBy`       | 修改页面大小（增量修改）             |
| `GetMaxSize`         | 获取页面最大容量                     |
| `SetMaxSize`         | 设置页面最大容量                     |
| `GetMinSize`         | 获取页面最小容量                     |

---

### **内部页面方法**
| 方法名               | 功能                                  |
| -------------------- | ------------------------------------- |
| `KeyAt`              | 获取指定索引的键                     |
| `SetKeyAt`           | 设置指定索引的键                     |
| `ValueAt`            | 获取指定索引的值                     |
| `ValueIndex`         | 查找值对应的索引                     |
| `ToString`           | 转换为调试字符串                     |

---

### **叶子页面方法**
| 方法名               | 功能                                  |
| -------------------- | ------------------------------------- |
| `GetNextPageId`      | 获取下一页的页面 ID                  |
| `SetNextPageId`      | 设置下一页的页面 ID                  |
| `KeyAt`              | 获取指定索引的键                     |
| `ToString`           | 转换为调试字符串                     |

---